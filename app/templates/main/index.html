{% extends "base.html" %}

{% block title %}PanelApp Gene Filter - Flask{% endblock %}

{% block head_extra %}
  <script>
    const maxPanels = {{ max_panels }};
    const listTypeOptions = {{ list_type_options | safe }};
  </script>
  <script src="{{ url_for('static', filename='js/panels.js') }}"></script>
{% endblock %}

{% block content %}
<div class="bg-red-100 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-3xl">
    <header class="mb-6 sm:mb-8 text-center">
        <h1 class="text-3xl sm:text-4xl font-bold text-sky-700">🔬 PanelApp Gene Filter</h1>
        <p class="text-gray-600 mt-2">
            Select up to {{ max_panels }} gene panels from UK and Australian PanelApp, filter by gene rating, and download the combined list.
        </p>
    </header>

    <!-- API Selection Tabs -->
    <div class="mb-6">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex" aria-label="Tabs">
                <button onclick="switchAPI('uk')" id="uk-tab" class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm cursor-pointer tab-button active" data-api="uk">
                    🇬🇧 UK PanelApp
                </button>
                <button onclick="switchAPI('aus')" id="aus-tab" class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm cursor-pointer tab-button" data-api="aus">
                    🇦🇺 Australian PanelApp
                </button>
            </nav>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-6 space-y-3">
            {% for category, message in messages %}
                <div class="p-4 rounded-md text-sm
                    {% if category == 'error' or category == 'danger' %} bg-red-100 text-red-700 border border-red-300
                    {% elif category == 'warning' %} bg-yellow-100 text-yellow-700 border border-yellow-300
                    {% elif category == 'success' %} bg-green-100 text-green-700 border border-green-300
                    {% else %} bg-blue-100 text-blue-700 border border-blue-300
                    {% endif %}" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="mb-6 p-4 border border-sky-200 rounded-lg bg-sky-50 text-sm text-sky-700">
        <h3 class="font-semibold mb-1">Note on Gene Ratings:</h3>
        <ul class="list-disc list-inside ml-2">
            <li><strong>Green (Confidence 3):</strong> High confidence.</li>
            <li><strong>Amber (Confidence 2):</strong> Moderate confidence.</li>
            <li><strong>Red (Confidence 1):</strong> Low confidence / evidence against.</li>
        </ul>
    </div>

    <h2 class="text-xl font-semibold text-sky-600 mb-3">Filter Panel List</h2>
    <div class="flex flex-col sm:flex-row sm:items-end gap-4 mb-6">
        <div class="flex-grow">
            <p class="text-sm text-gray-500 mb-1">
              Search for specific panels by name, disease group/sub-group, or description.
              Start typing in the search field and the drop-down lists of the panels are updated.
              Selections that you've already made are not removed from the list.
              If you want to see all available panels, just clear the search term.
              You can also clear all selections and the search term using the button below.
            </p>
            <label for="panelSearch" class="block text-sm font-medium text-gray-700 mb-1">
                Search term:
            </label>
            <input type="text" name="panelSearch" id="search_term_input" value="{{ search_term | default('') }}"
                   placeholder="e.g., malformation, cardiac, neuro"
                   class="form-input-custom mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm sm:text-sm">
        </div>
        <div>
            <button type="button" onclick="clearAll();" class="btn-clear-all">
                Clear All 🗑️
            </button>
        </div>
    </div>

    <form id="generateForm" method="POST" action="{{ url_for('main.generate') }}" class="space-y-8">
        <!-- Hidden input for keeping track of API sources -->
        <div id="panel-sources"></div>

        {% for i in range(1, max_panels+1) %}
        <div class="p-5 border border-gray-200 rounded-lg shadow-sm bg-gray-50">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-sky-600">Panel {{ i }} Configuration</h2>
                <button type="button" onclick="clearPanel({{ i }});" class="btn btn-clear">Clear Panel {{ i }}</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="panel_id_{{i}}" class="block text-sm font-medium text-gray-700 mb-1">Select Panel {{i}}:</label>
                    <select name="panel_id_{{i}}" id="panel_id_{{i}}" 
                            class="form-select-arrow form-select-custom mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm sm:text-sm appearance-none">
                    </select>
                    <input type="hidden" name="api_source_{{i}}" id="api_source_{{i}}" value="uk">
                </div>
                <div>
                    <label for="list_type_{{i}}" class="block text-sm font-medium text-gray-700 mb-1">Select List Type for Panel {{ i }}:</label>
                    <select name="list_type_{{i}}" id="list_type_{{i}}" 
                            class="form-select-arrow form-select-custom mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm sm:text-sm appearance-none">
                        {% for opt in list_type_options %}
                            <option value="{{opt}}"
                                    {% if current_selections and current_selections['list_type_' + i|string] == opt %}selected{% endif %}>
                                {{ opt }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>    
        </div>
        {% endfor %}

        <div class="mt-8 pt-6 border-t border-gray-200 text-center">
            <button type="submit"
                    class="w-full sm:w-auto inline-flex justify-center items-center px-8 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition duration-150 ease-in-out">
                🚀 Generate Gene List
            </button>
        </div>
    </form>
    <form method="POST" action="{{ url_for('main.clear_cache') }}" class="mb-4 text-right">
        <button type="submit" class="btn-clear-all">Clear Cache 🧹</button>
    </form>
  </div>
{% endblock %}